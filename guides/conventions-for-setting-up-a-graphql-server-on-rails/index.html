<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Conventions for setting up a GraphQL Server on Rails | Hari Gopal</title>
<meta name="generator" content="Jekyll v4.0.0" />
<meta property="og:title" content="Conventions for setting up a GraphQL Server on Rails" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="https://blog.harigopal.in/guides/conventions-for-setting-up-a-graphql-server-on-rails/" />
<meta property="og:url" content="https://blog.harigopal.in/guides/conventions-for-setting-up-a-graphql-server-on-rails/" />
<meta property="og:site_name" content="Hari Gopal" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-05T20:20:00+05:30" />
<script type="application/ld+json">
{"url":"https://blog.harigopal.in/guides/conventions-for-setting-up-a-graphql-server-on-rails/","headline":"Conventions for setting up a GraphQL Server on Rails","dateModified":"2019-11-05T20:20:00+05:30","datePublished":"2019-11-05T20:20:00+05:30","mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.harigopal.in/guides/conventions-for-setting-up-a-graphql-server-on-rails/"},"description":"Introduction","@type":"BlogPosting","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://blog.harigopal.in/feed.xml" title="Hari Gopal" />
    <!-- Google Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-89604247-2', 'auto');
	ga('send', 'pageview', { 'page': location.pathname + location.search + location.hash});
	ga('set', 'anonymizeIp', false);
    </script>
    <!-- End Google Analytics -->
    </head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Hari Gopal</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Conventions for setting up a GraphQL Server on Rails</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-11-05T20:20:00+05:30" itemprop="datePublished">Nov 5, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h2 id="introduction">Introduction</h2>

<p><em>“Convention over configuration”</em> is one of the reasons Rails became as popular as it did. Conventions allow developers to be productive without <a href="https://en.wiktionary.org/wiki/bikeshedding"><em>bike-shedding</em></a>. However, introducing new concepts to Rails involves a period of experimentation during which there are no answers to troublesome questions.</p>

<p>Setting up a GraphQL server on Rails is one of those tasks.</p>

<p>This post presents a method for setting up a GraphQL server, while also tackling two issues that are generally glossed over by existing documentation surrounding the use of the <code class="highlighter-rouge">graphql-ruby</code> gem:</p>

<ol>
  <li>How do I handle authorization?</li>
  <li>How do I avoid N+1 queries?</li>
</ol>

<h3 id="start-with-graphql-ruby">Start with <code class="highlighter-rouge">graphql-ruby</code></h3>

<p>Use <a href="https://graphql-ruby.org/getting_started">the gem’s documentation</a> to install and get started with <code class="highlighter-rouge">graphql-ruby</code>. The steps are straight-forward and well-documented, but I suggest not setting up queries and mutations yet - we’ll get to that.</p>

<p>Just like with Facebook’s documentation about authorization in GraphQL, the <a href="https://graphql-ruby.org/authorization/overview.html#authorization-in-your-business-logic">gem’s documentation also suggests pushing the responsibility into <em>business</em> logic</a>, specifically into model methods that accept <code class="highlighter-rouge">context</code> and decide what kind of relation or data is accessible for <em>that</em> user.</p>

<p>I’d like to suggest an alternative.</p>

<h3 id="resolvers-authorize-and-fetch-data"><em>Resolvers</em> authorize and fetch data</h3>

<p>Let’s start by adding an <code class="highlighter-rouge">ApplicationQuery</code> class that’ll act as the base class for <em>resolvers</em> and <em>mutators</em>:</p>

<script src="https://gist.github.com/harigopal/2270db1662f697fbbf8fd3303aca2029.js"></script>

<p>With that in place, we can start writing <em>resolver</em> objects that will help us retrieve properly authorized data for GraphQL queries. Let’s take the example of a query that asks for a list of users:</p>

<script src="https://gist.github.com/harigopal/124000d16b0188d283c6ed92763b1f4e.js"></script>

<p>Notice how the <code class="highlighter-rouge">users</code> method simply hands over the responsibility for loading the data to a <code class="highlighter-rouge">UsersResolver</code> object:</p>

<script src="https://gist.github.com/harigopal/d498086083b1db7180e407b43dbf7193.js"></script>

<p>What you’re looking at is the essence of this approach.</p>

<ol>
  <li>All requests are individually authorized.</li>
  <li>There is an assumption that once a query is authorized, all data returned by the resolver (or mutator) can be accessed by the authenticated user.</li>
  <li>Avoid N+1-s by making sure that the resolver method <code class="highlighter-rouge">includes</code> all necessary data for the response.</li>
</ol>

<p>Before we move onto mutators, let’s also look at how we deal with queries that have arguments, using a variation of what we’ve done above:</p>

<script src="https://gist.github.com/harigopal/d189b80d9d62acdde4bb6e4f8bd4d364.js"></script>

<p>Only a few things are different here:</p>

<ol>
  <li><code class="highlighter-rouge">args</code> is passed to the resolver in addition to context.</li>
  <li>There’s a <code class="highlighter-rouge">property :id</code> in the resolver class defining what data the query will work with.</li>
  <li>Instead of a relation, the <code class="highlighter-rouge">user</code> method in the resolver returns a <code class="highlighter-rouge">User</code> object, since the <em>type</em> for the query is a single object.</li>
</ol>

<h3 id="mutators-authorize-modify-and-supply-a-response"><em>Mutators</em> authorize, modify, and supply a response</h3>

<p>GraphQL mutations aren’t really all that different from queries. Mutations are queries that are, <em>by convention</em>, allowed to modify data. And just like queries, they too can return structured data.</p>

<p>As with queries, let’s start with a simple example that shows just how similar <em>mutators</em> are to <em>resolvers</em>.</p>

<script src="https://gist.github.com/harigopal/da0fe5301af5027e84ec0f0f9a5c83dc.js"></script>

<p>Notice how there’s a call to <code class="highlighter-rouge">.valid?</code> before the <code class="highlighter-rouge">.create_comment</code> is called. This triggers validations that can be configured in the mutator class:</p>

<script src="https://gist.github.com/harigopal/d64f6273011582b657af7a8a0bc30797.js"></script>

<p>Again, there’s very little that’s new here.</p>

<ol>
  <li>Because <code class="highlighter-rouge">ApplicationQuery</code> includes <code class="highlighter-rouge">ActiveModel::Model</code>, we have access to all of the validation methods that we’re familiar with.</li>
  <li>The <code class="highlighter-rouge">property</code> helper simply combines <code class="highlighter-rouge">validates</code> and <code class="highlighter-rouge">attr_accessor</code> into a single-step, and helps avoid bugs because the former depends on the latter.</li>
  <li>We can either process the request in the mutator directly in the <code class="highlighter-rouge">create_comment</code> method, or pass it onto a service as shown in the example.</li>
</ol>

<p>As with queries, there is an assumption that the <code class="highlighter-rouge">create_comment</code> method will return an object that responds to the <em>fields</em> mentioned in the mutation class. In this case, that’s <code class="highlighter-rouge">id</code>, and as long as the service returns a <code class="highlighter-rouge">Comment</code> object, everything should work as expected.</p>

<h4 id="create-types-for-complex-returns">Create types for complex returns</h4>

<p>While GraphQL unsubtly suggests the use of relations in your response types, there is no need to follow that pattern. Often, it’s much more straight-forward to create a custom type that fits exactly the data that you want to return:</p>

<script src="https://gist.github.com/harigopal/caba32c4f40f70c6ff8204def6281602.js"></script>

<p>Here, the custom <code class="highlighter-rouge">UpdatePostType</code> is used to compose exactly what the UI requires in this imaginary app, when a post is updated.</p>

<h3 id="what-are-the-advantages-of-this-approach">What are the advantages of this approach?</h3>

<ol>
  <li>You have a self-documenting API. Testing it is a breeze thanks to GraphiQL.</li>
  <li>Your API is integrated with the editor - it’ll suggest names, arguments, and return values - writing correct queries is much simpler.</li>
  <li>Your compiler will prevent the application from generating code with invalid queries.</li>
  <li>The Rails server will crash with a useful error message if your code ever disobeys the type specification.</li>
  <li>Pagination of resources is simple and straight-forward, thanks to <a href="https://graphql-ruby.org/relay/connections.html">built-in, well-thought-out conventions</a> that cover a large variety of pagination-use-cases.</li>
  <li>Avoids a lot of bike-shedding. <code class="highlighter-rouge">PUT</code> vs <code class="highlighter-rouge">PATCH</code>? <code class="highlighter-rouge">400</code> vs <code class="highlighter-rouge">422</code>? How to handle deprecation? These questions, and more, are no longer concerns.</li>
  <li>The server’s response can be extended to include more standardized behavior.</li>
</ol>

<h4 id="about-extensibility">About extensibility</h4>

<p>Your server always supplies a JSON response. This means that you can add more fields to it if you’d like.</p>

<p>In <a href="https://www.pupilfirst.com">PupilFirst</a>, we’ve expanded the response object to include a <code class="highlighter-rouge">notifications</code> field. If present, the response handler in the client automatically converts them into <em>flash</em> notifications that are shown to the user. This helps us preserve a <em>Rails-like</em> experience in our mutators, and keeps notifications <em>DRY</em>:</p>

<script src="https://gist.github.com/harigopal/0b208181f942adb7cc5beccbfdd5531a.js"></script>

<p>The query superclass has simple methods that inject notifications into the context…</p>

<script src="https://gist.github.com/harigopal/0b480036b4a5213077c538f49f19f87b.js"></script>

<p>…which then gets placed in the response by the GraphQL controller:</p>

<script src="https://gist.github.com/harigopal/675ef7e93ac142cef4a9d7bc1038b091.js"></script>

<h3 id="however-concerns-still-exist">However, concerns still exist</h3>

<h4 id="this-isnt-what-graphql-promised">This isn’t what GraphQL promised</h4>

<p>One of the stated advantages of GraphQL is that it solves the problem of over-fetching by allowing the client to specify exactly what data it needs, leading to the server fetching <em>only</em> the asked-for data.</p>

<p>This approach definitely <strong>ignores</strong> that goal. We’re taking this approach because of two reasons:</p>

<ol>
  <li>Over-fetching is not a problem for <a href="https://www.pupilfirst.com">us</a>. It might become a problem <em>at scale</em>, but we’re not at that size yet. It’s generally better to tackle problems that exist now (ease of API usage, and avoiding clerical mistakes), instead of one that <em>might</em> happen in the future.</li>
  <li>GraphQL doesn’t actually <em>do</em> anything to solve over-fetching - it just specifies how to deliver the data once you’re retrieved it. However, retrieving data correctly is <a href="https://graphql.org/learn/thinking-in-graphs/#business-logic-layer">still up to your <em>business logic</em></a>, which is always vaguely defined in all documentation that I’ve come across.</li>
</ol>

<p>Arbitrarily loading relational data and incurring huge performance hits is one of the easiest mistakes to make with GraphQL, and it’s not a problem whose solution is clear. At this point, I think it’s appropriate to mention that Shopify has released a <a href="#"><code class="highlighter-rouge">graphql-batch</code> gem</a> that <em>claims</em> to tackle this issue. Unfortunately, I think it’s poorly documented, and I couldn’t really make sense of how it’s supposed to work, but it may be worth looking at if you’re already <em>at scale</em>, and dealing with issues like over-fetching.</p>

<h4 id="why-not-authorize-fields">Why not authorize fields?</h4>

<p>The simple answer is that it’s much easier to think about authorizing requests rather than fields. Requests always have a context which can be used to determine whether <em>this</em> user is allowed to access some data or make a change.</p>

<p>However, if the fields that a client can request are unbounded, i.e., the type allows the client to dig deeper into relationships and ask for <em>distant</em> data, then field-level authorization is your only option. This is why we suggest creating response types specific to queries if the requested data is complicated. Yes, this is restrictive, but requires only one authorization, and ensures that we’re limiting the response to a selection of data that we know the client is <em>definitely</em> allowed to access.</p>

<h4 id="how-is-this-any-different-from-rest">How is this any different from REST?</h4>

<p>First, I’d like to point you to the list of advantages written above.</p>

<p>You’ll notice that the process I’ve suggested is very similar to how REST works. And you know what? REST has some <em>really</em> good ideas about how to manage communication - it’s just that <em>some</em> of its requirements don’t make sense anymore when building APIs. REST has an uncomplicated approach to authorization and data-delivery that I think we should adopt even when we’re using GraphQL.</p>

<h3 id="a-real-world-example">A real-world example</h3>

<p>If you’d like to take a look at a Rails application that uses this approach, take a look at codebase for <a href="https://github.com/SVdotCO/pupilfirst">the PupilFirst LMS</a>. The patterns described here were created as <a href="https://www.sv.co">our team</a> gradually switched to using ReasonML and ReasonReact on the front-end, and adopted GraphQL in order to leverage the presence of types and a compiler.</p>

  </div><a class="u-url" href="/guides/conventions-for-setting-up-a-graphql-server-on-rails/" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Hari Gopal</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Hari Gopal</li><li><a class="u-email" href="mailto:mail@harigopal.in">mail@harigopal.in</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/harigopal"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">harigopal</span></a></li><li><a href="https://www.twitter.com/harigopal"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">harigopal</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>My thoughts on programming, and more.
</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
